package mysql

import "testing"

var pktValid = []byte{
	0x53, 0x00, 0x00, 0x00, 0x03, 0x53, 0x45, 0x4c, 0x45, 0x43, 0x54, 0x20, 0x61, 0x72,
	0x74, 0x69, 0x63, 0x6c, 0x65, 0x2c, 0x20, 0x64, 0x65, 0x61, 0x6c, 0x65, 0x72, 0x2c,
	0x20, 0x70, 0x72, 0x69, 0x63, 0x65, 0x20, 0x46, 0x52, 0x4f, 0x4d, 0x20, 0x73, 0x68,
	0x6f, 0x70, 0x20, 0x57, 0x48, 0x45, 0x52, 0x45, 0x20, 0x20, 0x70, 0x72, 0x69, 0x63,
	0x65, 0x3d, 0x28, 0x53, 0x45, 0x4c, 0x45, 0x43, 0x54, 0x20, 0x4d, 0x41, 0x58, 0x28,
	0x70, 0x72, 0x69, 0x63, 0x65, 0x29, 0x20, 0x46, 0x52, 0x4f, 0x4d, 0x20, 0x73, 0x68,
	0x6f, 0x70, 0x29}

var pktInvalid = []byte{
	0x53, 0x00, 0x00, 0x00, 0x01, 0x53, 0x45, 0x4c, 0x45, 0x43, 0x54, 0x20, 0x61, 0x72,
	0x74, 0x69, 0x63, 0x6c, 0x65, 0x2c, 0x20, 0x64, 0x65, 0x61, 0x6c, 0x65, 0x72, 0x2c,
	0x20, 0x70, 0x72, 0x69, 0x63, 0x65, 0x20, 0x46, 0x52, 0x4f, 0x4d, 0x20, 0x73, 0x68,
	0x6f, 0x70, 0x20, 0x57, 0x48, 0x45, 0x52, 0x45, 0x20, 0x20, 0x70, 0x72, 0x69, 0x63,
	0x65, 0x3d, 0x28, 0x53, 0x45, 0x4c, 0x45, 0x43, 0x54, 0x20, 0x4d, 0x41, 0x58, 0x28,
	0x70, 0x72, 0x69, 0x63, 0x65, 0x29, 0x20, 0x46, 0x52, 0x4f, 0x4d, 0x20, 0x73, 0x68,
	0x6f, 0x70, 0x29}

var expected = "SELECT article, dealer, price FROM shop WHERE  price=(SELECT MAX(price) FROM shop)"

func TestParseComQuery(t *testing.T) {
	parsed, err := ParseComQuery(pktValid)
	if err != nil {
		t.Fatal(err.Error())
	}

	if parsed.Query != expected {
		t.Error("Parsed query does not match reference query")
	}
}

func TestParseComQueryInvalid(t *testing.T) {
	_, err := ParseComQuery(pktInvalid)
	if err == nil {
		t.Error("Invalid reference pkt but got no error")
	}
}
